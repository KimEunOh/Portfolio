# WebSocket 기반 실시간 스트리밍 채팅 시스템

![License](https://img.shields.io/badge/License-MIT-blue.svg)
![FastAPI](https://img.shields.io/badge/FastAPI-0.103.1-009688.svg)
![WebSocket](https://img.shields.io/badge/WebSocket-Real--time-4DB6AC.svg)
![Python](https://img.shields.io/badge/Python-3.9+-3776AB.svg)
![OpenAI](https://img.shields.io/badge/OpenAI-GPT--4-412991.svg)

## 프로젝트 개요

본 프로젝트는 WebSocket 기술을 활용한 고성능 실시간 스트리밍 채팅 시스템으로, 대규모 동시 접속과 실시간 메시지 처리를 지원하는 아키텍처를 구현했습니다. 유튜브 라이브 채팅처럼 여러 사용자가 실시간으로 소통할 수 있는 환경을 제공하며, AI 기반 대화 기능을 통합했습니다.

## 기술 스택

### 백엔드
- **FastAPI**: 비동기 처리 기반의 고성능 웹 프레임워크
- **WebSocket**: 실시간 양방향 통신 프로토콜
- **SQLAlchemy**: ORM(Object-Relational Mapping) 라이브러리
- **Alembic**: 데이터베이스 마이그레이션 도구
- **Bcrypt**: 보안 해싱 알고리즘

### 프론트엔드
- **HTML5 / CSS3 / JavaScript**: 웹 표준 기술
- **Bootstrap**: 반응형 UI 프레임워크
- **Jinja2**: 서버 사이드 템플릿 엔진

### 인공지능 및 외부 서비스
- **OpenAI API**: GPT 모델 통합으로 AI 채팅 기능 구현

### 시스템 운영
- **Locust**: 부하 테스트 및 성능 분석
- **Redis**: 메시지 캐싱 및 WebSocket 브로드캐스팅 최적화 (선택적)

## 시스템 아키텍처

```
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│                 │      │                 │      │                 │
│  클라이언트      │◄────►│  WebSocket 서버  │◄────►│  데이터베이스     │
│  (브라우저)      │      │  (FastAPI)      │      │  (SQLite)       │
│                 │      │                 │      │                 │
└─────────────────┘      └───────┬─────────┘      └─────────────────┘
                                 │
                                 ▼
                         ┌─────────────────┐
                         │                 │
                         │   AI 서비스      │
                         │  (OpenAI API)   │
                         │                 │
                         └─────────────────┘
```

## 구현 상태

### 구현 완료된 기능
- **WebSocket 기반 실시간 통신**: FastAPI를 활용한 양방향 통신 구현
- **다중 채팅방 시스템**: 채팅방 생성 및 참여자 관리 기능
- **사용자 인증 및 관리**: 회원가입, 로그인, 역할 기반 권한 관리
- **메시지 영속성**: SQLite 데이터베이스를 통한 메시지 저장
- **단일 서버 내 샤딩**: 사용자 ID 기반 샤딩으로 연결 분산 처리
- **메모리 관리 최적화**: Weak Reference를 활용한 메모리 누수 방지
- **메시지 배치 처리**: 효율적인 브로드캐스팅을 위한 배치 프로세싱
- **비동기 처리 아키텍처**: 이벤트 루프 블로킹 방지 설계

### 부분적으로 구현된 기능
- **Redis 통합**: 구현되어 있으나 선택적 사용 가능하며 세션 관리에 제한적 활용
- **메시지 큐**: 인메모리 방식의 샤드별 메시지 큐만 구현, 외부 메시지 큐 시스템 미통합
- **성능 분석**: Locust 설정은 존재하나 종합적인 모니터링 체계 미흡
- **오류 복구 메커니즘**: 기본적인 오류 처리 기능은 있으나 장애 상황 대응에 한계

### 미구현 및 한계점
- **분산 메시지 큐**: Kafka가 코드상 준비되었으나 비활성화된 상태(`USE_KAFKA = False`)
- **복수 인스턴스 간 세션 일관성**: 여러 서버 간 사용자 세션 동기화 메커니즘 부재
- **데이터베이스 확장성**: SQLite 사용으로 대규모 동시 쓰기 작업에 병목 현상 발생
- **로드 밸런싱**: 다중 서버 환경을 위한 부하 분산 체계 미구현
- **자동 확장 시스템**: 트래픽 변동에 따른 자동 스케일링 기능 부재

## 메시지 처리 파이프라인

현재 구현된 메시지 처리 흐름은 다음과 같습니다:

1. 클라이언트 메시지 수신 (WebSocket)
2. 메시지 유효성 검증 및 처리
3. 데이터베이스 저장
4. 샤드별 메시지 큐 분배
5. 배치 프로세싱 후 브로드캐스트
6. 클라이언트 전송 (비동기)

## 성능 지표

현재 시스템의 성능 측정 결과:

- **동시 접속**: 단일 서버에서 200~300명의 동시 접속자 처리 가능
- **메시지 처리량**: 초당 50~100개 메시지 처리 (SQLite 데이터베이스 기준)
- **응답 시간**: 
  - 일반 메시지: 평균 100~200ms 응답 시간
  - AI 응답 메시지: 외부 API 응답 시간에 따라 500ms~2초

## 설치 및 실행 방법

### 필수 요구사항
- Python 3.9 이상
- 가상 환경 관리자 (venv, conda 등)
- OpenAI API 키 (AI 채팅 기능 사용 시)

### 설치 과정

1. 저장소 클론 및 디렉토리 이동
```bash
git clone https://github.com/yourusername/realtime-chat-system.git
cd realtime-chat-system
```

2. 가상환경 생성 및 활성화
```bash
python -m venv .venv
# Windows
.venv\Scripts\activate
# macOS/Linux
source .venv/bin/activate
```

3. 의존성 패키지 설치
```bash
pip install -r requirements.txt
```

4. 환경 변수 설정
- `.env` 파일 생성 후 필요한 환경 변수 설정
```
OPENAI_API_KEY=your_api_key_here
```

5. 데이터베이스 초기화 및 관리자 계정 생성
```bash
python init_admin.py
```

### 실행 방법

#### 개발 모드
```bash
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

#### 프로덕션 모드
```bash
uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
```

#### 부하 테스트
```bash
locust -f locustfile.py
```

## 향후 개선 계획

### 분산 시스템 아키텍처 구축
- **메시지 큐 시스템 활성화**: Kafka 또는 RabbitMQ를 활용한 분산 메시지 큐 구현
- **분산 세션 관리**: Redis를 통한 중앙화된 세션 저장소로 복수 인스턴스 간 일관성 보장
- **로드 밸런싱 도입**: 들어오는 연결 및 메시지를 여러 서버에 효율적으로 분산
- **서버 간 상태 동기화**: 채팅 상태 동기화 메커니즘 구현

### 데이터베이스 및 성능 최적화
- **PostgreSQL 마이그레이션**: 확장성이 높은 RDBMS로 전환
- **데이터베이스 샤딩**: 대규모 데이터 처리를 위한 샤딩 및 파티셔닝 전략 구현
- **읽기/쓰기 분리**: 데이터베이스 부하 분산을 위한 아키텍처 개선
- **캐싱 계층 강화**: 다층적 캐싱 시스템 구축

### 기능 확장 및 사용자 경험 개선
- **클라이언트 최적화**: 메시지 버퍼링, 리소스 캐싱, DOM 업데이트 효율화
- **WebRTC 통합**: 음성/영상 채팅 기능 추가
- **AI 모델 확장**: 다양한 AI 모델 및 기능 지원
- **End-to-End 암호화**: 메시지 보안 강화

### 시스템 안정성 강화
- **고가용성 아키텍처**: 서비스 중단을 최소화하는 클러스터 구현
- **자동 복구 시스템**: 장애 상황에서의 복구 및 메시지 재전송 메커니즘
- **마이크로서비스 아키텍처**: 기능별 독립 서비스 분리로 확장성 및 유지보수성 향상
- **통합 모니터링**: 분산 환경에서의 모니터링 및 알림 시스템 구축

## 라이선스

이 프로젝트는 MIT 라이선스를 따릅니다. 자세한 내용은 LICENSE 파일을 참조하세요. 