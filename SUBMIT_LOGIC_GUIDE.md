# 문서 제출 로직 (`submitDocument` 함수) 가이드라인 및 고려 사항

이 문서는 `static/index.html` 내 `submitDocument()` 함수의 현재 구현 상태와 향후 확장 및 유지보수를 위한 주요 고려 사항을 정리합니다.

## 현재 주요 작업 흐름

1.  **기본 정보 유효성 검사**: `currentFormResponse` 객체, `mstPid`, `drafterId` 등의 필수 정보가 있는지 확인합니다.
2.  **공통 정보 수집**: `mstPid`, `aprvNm` (양식 유형), `drafterId`, `lineList` (결재선 정보)를 `currentFormResponse`에서 추출합니다.
3.  **양식 유형(`form_type`)에 따른 특화 정보 수집**:
    *   **`docCn` (문서 내용/사유)**: 각 양식의 주요 내용/사유를 담고 있는 HTML 요소(ID 기반 조회)의 값 또는 `currentFormResponse.slots` 내의 관련 값을 사용합니다.
    *   **`dayList` (날짜 목록)**: 날짜 기간이 있는 양식(예: 연차 신청서, 파견 및 출장 보고서 등)의 경우, HTML 요소 또는 슬롯에서 시작일/종료일을 가져와 날짜 목록을 생성합니다. 각 날짜 항목은 `{ reqYmd: "YYYY-MM-DD", dvType: "..." }` 형태를 가집니다.
    *   **`itemList` (항목 목록)**: 테이블 형태의 반복 항목이 있는 양식(예: 비품/소모품 구입내역서, 구매 품의서, 개인경비 사용내역서, 법인카드 지출내역서 등)의 경우, HTML 내의 `.item-set` 클래스를 가진 요소들을 순회하며 각 항목의 데이터를 추출합니다. 추출된 데이터는 객체의 배열 형태로 구성됩니다.
4.  **API 페이로드(payload) 구성**: 위에서 수집된 모든 정보를 취합하여 API 서버로 전송할 JSON 페이로드를 생성합니다.
5.  **API 호출 및 응답 처리**: 구성된 페이로드를 `/api/v1/epaper/register` (현재 하드코딩된 URL) 엔드포인트로 `POST` 방식으로 전송하고, 서버 응답에 따라 사용자에게 성공 또는 실패 메시지를 알립니다.

## 다음 단계 및 주요 고려 사항

다음은 `submitDocument` 함수를 개선하고 다양한 양식을 안정적으로 지원하기 위해 반드시 검토하고 진행해야 할 사항들입니다.

### 1. `itemList` 필드명 및 HTML ID 규칙 확인/조정 (매우 중요)

*   **API 필드명 확정**: 각 양식("비품/소모품 구입내역서", "구매 품의서", "개인경비 사용내역서", "법인카드 지출내역서" 등)의 `itemList` 내 각 항목 객체가 가져야 할 **정확한 JSON 키 (API 서버가 기대하는 필드명)**를 API 명세서를 통해 확인해야 합니다.
    *   현재 코드의 `fieldMapping` 객체 내에 정의된 키들(예: `itemName`, `quantity`, `unitPrice`, `date`, `category`, `merchantName` 등)은 **임시 예시**이며, 실제 API 명세와 다를 수 있습니다.
*   **HTML ID 및 구조 일관성/정확성 검증**:
    *   각 양식 템플릿 HTML(`templates/*.html`) 내에서 반복되는 항목들의 ID가 실제로 코드(`submitDocument` 내 `itemList` 수집 로직)에서 가정하는 규칙을 따르는지 면밀히 검토해야 합니다.
        *   예시 규칙: `item_name_1`, `item_quantity_1` 또는 `expense_date_1`, `expense_category_1` 등.
    *   숫자 인덱싱 방식(1부터 시작하는지, 0부터 시작하는지 등)이 코드의 가정과 일치하는지 확인합니다. (현재 코드는 `index + 1`을 사용하여 1부터 시작하는 ID를 가정)
    *   `baseId` (예: `item_`, `expense_`, `usage_`)와 `fieldMapping`의 접미사(예: `name_${index + 1}`) 부분이 실제 HTML 요소의 ID와 정확히 일치하도록 수정해야 합니다.
    *   항목 그룹을 식별하는 클래스명(현재 `.item-set`)이 모든 관련 양식에서 일관되게 사용되는지 확인합니다.

### 2. `dayList`의 `dvType` 구체화

*   **"연차 신청서" `dvType` 매핑**: `slots.leave_type` (예: 'annual', 'half\_day\_morning')을 API가 요구하는 `dvType` 문자열(예: 'DAY', 'HALF\_AM')로 변환하는 로직을 API 명세에 맞춰 정확하게 구현해야 합니다. (현재는 예시 수준)
*   **기타 양식 `dvType` 정의**: "파견 및 출장 보고서" 등 `dayList`가 필요한 다른 양식들의 경우, 각 날짜 항목에 대한 `dvType` 값을 무엇으로 설정할지 API 명세 또는 내부 규칙에 따라 명확히 정의해야 합니다. (현재 "BUSINESSTRIP"은 예시)

### 3. `docCn` (문서 내용/사유) 수집 상세화

*   각 양식별로 `docCn`으로 사용할 가장 적절한 필드(HTML 요소 ID 또는 슬롯 키)를 다시 한번 검토하고 확정합니다.
*   단일 필드 값을 사용할지, 또는 여러 필드의 내용을 조합하여 `docCn`을 구성할지 정책을 결정합니다.

### 4. 데이터 유효성 검사 강화 (Client-side Validation)

*   현재는 기본적인 값 존재 여부 위주로 데이터를 수집하고 있습니다.
*   **제출 전 필수 검증**: 실제 API 요청을 보내기 전에, 각 필드별로 더 구체적인 유효성 검사를 클라이언트 사이드(JavaScript)에서 수행하는 것이 매우 중요합니다.
    *   검사 항목 예시: 필수 입력 항목 누락, 숫자/날짜 형식 및 범위 유효성, 이메일 형식, 최소/최대 길이, 항목 간 논리적 일관성 (예: 시작일 < 종료일) 등.
*   **피드백**: 유효성 검사 실패 시, 사용자에게 어떤 정보가 잘못되었는지 명확하고 친절하게 알려주는 피드백 메커니즘이 필요합니다.

### 5. API Payload 최종 확정

*   `itemList`나 `dayList`가 없는 양식의 경우, 해당 키를 최종 페이로드에서 제외할지, 또는 빈 배열 `[]`로 전송할지 API 명세에 따라 결정해야 합니다. (현재는 빈 배열로 포함)
*   모든 페이로드 내 필드명과 값의 데이터 타입(문자열, 숫자, 배열 등)이 API 서버의 요구사항과 정확히 일치하는지 최종 확인합니다.

### 6. 테스트 철저

*   **단위/통합 테스트**:
    *   다양한 양식을 선택하고, 각 필드에 정상적인 데이터뿐만 아니라 경계값, 예상치 못한 오류 데이터(잘못된 형식, 빈 값 등)를 입력해보면서, 제출 시 생성되는 페이로드(브라우저 개발자 도구 콘솔에서 `console.log("제출할 데이터:", ...)` 출력 확인)가 모든 경우에 대해 정확한지 검증합니다.
    *   실제 API 서버와 연동한 후에는, 다양한 요청에 대한 서버의 응답(성공, 각종 오류 코드)을 면밀히 테스트하고, 그에 따른 클라이언트의 예외 처리 로직이 올바르게 동작하는지 확인해야 합니다.

### 7. 함수 모듈화 (가독성 및 유지보수성 향상)

*   현재 `submitDocument` 함수는 여러 양식의 데이터 수집 및 처리 로직을 모두 포함하고 있어, 향후 양식이 더 추가되면 코드가 지나치게 길고 복잡해질 수 있습니다.
*   **리팩토링 제안**: 양식 유형(`form_type`)별 데이터 수집 로직(특히 `docCn`, `dayList`, `itemList`를 구성하는 부분)을 별도의 함수나 객체로 분리하는 모듈화를 적극 고려해야 합니다.
    *   **방법 A: `formProcessors` 객체 활용**: `index.html` 내에 각 `form_type`을 키로 하고, 해당 양식의 데이터 처리 함수들을 값으로 가지는 객체를 정의합니다. `submitDocument`는 이 객체에서 적절한 처리 함수를 찾아 호출합니다.
    *   **방법 B: 양식별 JS 파일 및 동적 함수 호출**: 각 양식에 대한 전용 `.js` 파일을 만들고 (예: `js/annual_leave_handler.js`), 이 파일 내에 해당 양식의 데이터를 반환하는 함수(예: `window.getSpecificFormData_연차신청서`)를 정의합니다. `submitDocument`는 `form_type`에 따라 이 함수를 동적으로 찾아 호출합니다. (이 방식은 양식별 스크립트 로드 메커니즘과 연계 필요)
*   모듈화를 통해 `submitDocument` 함수의 본체는 공통 로직(정보 취합, API 호출, 기본 응답 처리)에 집중하고, 양식별 세부 로직은 각 모듈에서 담당하도록 하여 코드의 가독성, 관리 용이성, 확장성을 높일 수 있습니다.

### 8. 사용자 경험(UX) 개선

*   **상태 표시**: API 호출 등 비동기 작업 진행 중임을 사용자에게 명확히 알리기 위해 로딩 스피너나 버튼 비활성화 이상의 시각적 피드백을 제공하는 것을 고려합니다.
*   **알림 방식**: 현재 `alert()`를 사용하는 성공/실패 알림은 사용자 경험을 저해할 수 있습니다. 페이지 내 비간섭적인 토스트(Toast) 알림이나 좀 더 상세한 정보를 제공할 수 있는 모달(Modal) 대화상자로 대체하는 것을 검토합니다.

---

위 가이드라인은 전자결재 양식 자동 추천 및 완성 시스템의 문서 제출 기능의 안정성과 확장성을 확보하는 데 중요한 역할을 할 것입니다. API 명세가 확정되고 새로운 기능 요구사항이 발생함에 따라 이 문서는 지속적으로 업데이트되어야 합니다. 