# Deepfake 프로젝트 구조 분석

## 1. 현재 프로젝트 구조

```
deepfake/
├── README.md
├── src/
│   ├── gradcam/
│   ├── utils/
│   └── models/
├── data/
├── docs/
├── notebooks/
│   ├── model_dev/
│   ├── experiments/
│   ├── evaluation/
│   └── data_prep/
└── results/
```

## 2. 파일 분석 및 재구성 작업 로그

### 2.1 기본 디렉토리 구조 검증
- [x] 프로젝트 기본 구조 확인
- [x] README.md 존재 확인
- [x] 주요 디렉토리 구조 검증

### 2.2 파일 분석 진행 상황
1. src/ 디렉토리
   - [x] gradcam/ 분석
   - [ ] utils/ 분석
   - [ ] models/ 분석

2. notebooks/ 디렉토리
   - [ ] model_dev/ 분석
   - [ ] experiments/ 분석
   - [ ] evaluation/ 분석
   - [ ] data_prep/ 분석

3. 기타 디렉토리
   - [ ] data/ 분석
   - [ ] docs/ 분석
   - [ ] results/ 분석

## 3. 세부 분석 로그

각 파일 분석 시 다음 항목을 체크:
1. 파일 위치의 적절성
2. README.md 문서화 여부
3. 코드 품질 및 문서화 상태
4. 재배치 필요성

### 3.1 src/gradcam/gradcam++.py 분석

**파일 개요:**
- CLIP 모델과 GradCAM을 결합하여 이미지 분석을 수행하는 코드
- 다양한 CAM 방식 지원 (GradCAM, ScoreCAM, GradCAM++, AblationCAM 등)

**코드 분석:**
1. 위치 적절성: ✓
   - src/gradcam 디렉토리에 위치한 것이 적절함
   - 시각화 관련 코드로 독립적인 모듈로 구성됨

2. README.md 문서화: △
   - README.md에 GradCAM++ 관련 내용이 있으나 구체적인 사용법 부재
   - 추가 문서화 필요

3. 코드 품질: ✓
   - 잘 구조화된 클래스 및 함수 구조
   - 적절한 에러 처리 및 인자 파싱
   - 코드 주석이 충분함

4. 재배치 필요성: ✕
   - 현재 위치가 적절함

**개선 필요사항:**
1. README.md에 다음 내용 추가 필요:
   - GradCAM++ 사용 방법 및 예시
   - 지원하는 CAM 방식들의 설명
   - 실행 방법 및 파라미터 설명

2. 코드 개선사항:
   - 하드코딩된 이미지 경로 수정 필요
   - 설정 파일로 분리 가능한 상수들 존재

### 3.2 src/utils/ 분석

#### 3.2.1 llava_convert.py 분석

**파일 개요:**
- JSONL 형식의 데이터를 LLaVA 모델 학습용 포맷으로 변환하는 유틸리티
- 시스템 프롬프트, 사용자 프롬프트, 이미지 URL을 포함한 대화 형식으로 변환

**코드 분석:**
1. 위치 적절성: ✓
   - utils 디렉토리 내 위치가 적절함
   - 데이터 변환 유틸리티로서의 역할에 부합

2. README.md 문서화: ✕
   - 데이터 변환 과정과 포맷에 대한 설명 부재
   - 추가 문서화 필요

3. 코드 품질: ✓
   - 명확한 함수 구조와 에러 처리
   - UTF-8 인코딩 처리 포함
   - 적절한 주석 포함

4. 재배치 필요성: ✕
   - 현재 위치가 적절함

#### 3.2.2 convert.py 분석

**파일 개요:**
- JSONL 형식의 데이터를 다른 형식으로 변환하는 유틸리티
- 시스템, 사용자, 어시스턴트 메시지를 포함한 대화 형식으로 변환

**코드 분석:**
1. 위치 적절성: ✓
   - utils 디렉토리 내 위치가 적절함
   - 데이터 변환 유틸리티로서의 역할에 부합

2. README.md 문서화: ✕
   - 변환 프로세스와 입출력 포맷에 대한 설명 부재
   - 추가 문서화 필요

3. 코드 품질: △
   - 하드코딩된 파일 경로 존재
   - 기본적인 에러 처리 부재
   - 한글 주석 사용

4. 재배치 필요성: ✕
   - 현재 위치가 적절함

**개선 필요사항:**
1. README.md에 다음 내용 추가 필요:
   - 데이터 변환 유틸리티들의 사용 방법
   - 입출력 데이터 포맷 설명
   - 실행 방법 및 예시

2. 코드 개선사항:
   - 하드코딩된 경로를 설정 파일이나 커맨드라인 인자로 변경
   - 에러 처리 로직 추가
   - 영문 주석으로 통일
   - 두 변환 스크립트 간의 중복 코드 제거 검토

### 3.3 src/models/ 분석

**디렉토리 개요:**
- YOLOv8 사전 학습 모델 파일 저장소
- 현재 포함된 파일: yolov8n.pt (6.2MB)

**분석:**
1. 위치 적절성: ✓
   - 모델 파일을 저장하는 용도로 적절한 위치
   - 버전 관리 시스템에서 큰 바이너리 파일 관리 필요

2. README.md 문서화: △
   - YOLOv8 모델 사용에 대한 설명은 있으나 구체적인 모델 정보 부재
   - 모델 버전 및 학습 정보 문서화 필요

3. 디렉토리 구조: △
   - 단일 모델 파일만 존재
   - 다른 모델들을 위한 구조화 필요

4. 재배치 필요성: ✕
   - 현재 위치가 적절함

**개선 필요사항:**
1. README.md에 다음 내용 추가 필요:
   - 사용된 YOLOv8 모델의 구체적인 버전 정보
   - 모델 다운로드 및 설치 방법
   - 모델 성능 지표
   - 사용된 학습 데이터셋 정보

2. 디렉토리 구조 개선:
   - 모델 버전별 서브디렉토리 구성 검토
   - 모델 설정 파일 추가 검토
   - 체크포인트 저장 구조 검토

### 3.4 notebooks/model_dev/ 분석

**디렉토리 개요:**
- 모델 개발 및 실험을 위한 Jupyter 노트북 모음
- 총 10개의 노트북 파일 포함

**파일 목록:**
1. rag_performance_visual.ipynb (239KB, 569 lines)
   - CLIP 모델과 GradCAM을 활용한 시각화 실험
   - 모델 해석을 위한 다양한 CAM 기법 구현

2. QwQ_rag.ipynb (269KB, 2904 lines)
   - RAG 기반 딥페이크 이미지 분석 시스템
   - CLIP과 Together API를 활용한 이미지-텍스트 분석

3. QwQ_detection.ipynb (269KB, 4511 lines)
   - 딥페이크 이미지 탐지 모델 구현
   - 상세 분석 진행 예정

4. LLaVA_tuning.ipynb (302KB, 3041 lines)
   - LLaVA 모델 파인튜닝 실험
   - 상세 분석 진행 예정

5. finetuning_model.ipynb (125KB, 1232 lines)
   - LLaVA 모델의 파인튜닝을 위한 환경 설정 및 학습 구현
   - 딥페이크 탐지를 위한 커스텀 데이터셋 학습 파이프라인

6. fine.ipynb (20KB, 343 lines)
   - 간단한 파인튜닝 실험
   - 상세 분석 진행 예정

7. Llama_rag.ipynb (89KB, 1155 lines)
   - Llama 모델 기반 RAG 시스템 구현
   - 상세 분석 진행 예정

8. Llama_rag copy.ipynb (271KB, 2894 lines)
   - Llama_rag.ipynb의 복사본
   - 상세 분석 진행 예정

9. Llama_detection.ipynb (129KB, 1633 lines)
   - Llama 모델 기반 딥페이크 탐지 구현
   - 상세 분석 진행 예정

10. CLIP_RAG.ipynb (19KB, 451 lines)
    - CLIP 모델 기반 RAG 시스템 구현
    - 상세 분석 진행 예정

#### 3.4.1 rag_performance_visual.ipynb 분석

**파일 개요:**
- CLIP 모델과 GradCAM을 활용한 시각화 실험 노트북
- 다양한 CAM 기법을 통한 모델 해석 구현

**코드 분석:**
1. 주요 기능:
   - CLIP 모델 기반 이미지 분류
   - 다양한 CAM 기법 구현 (GradCAM, ScoreCAM, GradCAM++ 등)
   - 시각화 결과 생성 및 저장

2. 구조적 특징:
   - ImageClassifier 클래스를 통한 CLIP 모델 래핑
   - 커맨드라인 인터페이스 제공
   - 모듈화된 시각화 파이프라인

3. 코드 품질: ✓
   - 체계적인 구조와 명확한 주석
   - 에러 처리 포함
   - 설정 가능한 파라미터 구조

4. 개선 필요사항:
   - 하드코딩된 경로 수정 필요
   - 배치 처리 기능 추가 검토
   - 결과 저장 경로 설정 옵션 추가

**현재 분석 중인 파일:**
- QwQ_rag.ipynb 분석 예정

#### QwQ_rag.ipynb 분석

이 노트북은 딥페이크 이미지 분석을 위한 RAG(Retrieval-Augmented Generation) 시스템을 구현합니다.

**파일 개요:**
- CLIP 모델과 Together API를 활용하여 이미지-텍스트 임베딩 기반의 딥페이크 분석 시스템 구현
- 이미지의 특징을 키워드로 추출하고, 이를 기반으로 프롬프트를 생성하여 LLM에게 분석 요청

**주요 기능:**
1. **데이터 준비 및 설정**
   - CLIP 모델과 프로세서 초기화
   - Together API 클라이언트 설정
   - 테스트 데이터셋 로드 및 필터링

2. **핵심 함수들**
   - `load_keyword_embeddings()`: 저장된 키워드 임베딩 로드
   - `get_github_image_urls()`: GitHub에서 이미지 URL 가져오기
   - `embed_image_and_calculate_similarity()`: 이미지 임베딩 생성 및 키워드와 유사도 계산
   - `generate_prompts()`: 분석용 프롬프트 생성
   - `save_rag_dataset()`: RAG 데이터셋 저장

3. **분석 파이프라인**
   - Pydantic을 사용한 응답 검증
   - 구조화된 JSON 응답 처리
   - 체계적인 이미지 분석 프로세스

**코드 품질:**
- 모듈화된 구조와 명확한 함수 분리
- 예외 처리와 로깅 구현
- Pydantic을 통한 데이터 검증
- 재사용 가능한 컴포넌트 설계

**개선 제안:**
1. API 키 보안 강화 필요 (현재 하드코딩됨)
2. 배치 처리 기능 추가 고려
3. 캐싱 메커니즘 도입 검토
4. 더 상세한 에러 처리 및 복구 메커니즘 추가

#### 3.4.3 QwQ_detection.ipynb 분석

**파일 개요:**
- Together API와 LLM을 활용한 딥페이크 이미지 탐지 시스템 구현
- 포렌식 전문가 관점의 이미지 분석 프레임워크 적용

**주요 기능:**
1. **시스템 설정**
   - Together API 클라이언트 초기화
   - 성능 평가를 위한 sklearn 메트릭스 설정

2. **분석 프레임워크**
   - 얼굴 특징 분석 (정렬, 대칭성, 시선, 동공)
   - 피부 텍스처와 톤 분석
   - 저수준 디테일 검사 (경계, 왜곡, 그림자)
   - 조명과 환경 일관성 검증
   - 딥페이크 특징 탐지 (표정, 주름 왜곡)

3. **응답 처리**
   - JSON 형식의 구조화된 응답 처리
   - Pydantic을 통한 응답 검증
   - 결과 및 근거 제공

**코드 품질:**
- 체계적인 분석 프레임워크 구현
- 명확한 프롬프트 구조화
- 데이터 검증 메커니즘 포함
- 상세한 분석 기준 정의

**개선 제안:**
1. API 키의 환경 변수 처리 필요
2. 배치 처리 기능 추가 검토
3. 분석 결과의 시각화 기능 추가
4. 성능 메트릭스 저장 및 추적 기능

#### 3.4.4 LLaVA_tuning.ipynb 분석

**파일 개요:**
- LLaVA(Large Language and Vision Assistant) 모델의 파인튜닝 구현
- 딥페이크 탐지를 위한 데이터셋 전처리 및 학습 파이프라인 구성

**주요 기능:**
1. **데이터 전처리**
   - JSONL 형식의 데이터를 LLaVA 학습용 포맷으로 변환
   - 이미지 다운로드 및 저장 자동화
   - UUID 기반 고유 식별자 관리

2. **데이터셋 구성**
   - 대화형 데이터 구조 생성
   - 시스템 메시지와 응답 결합
   - 이미지-텍스트 페어링 처리

3. **학습 환경 설정**
   - LLaVA 깃허브 레포지토리 클론
   - 필요한 의존성 설치
   - 학습 파라미터 설정

**코드 품질:**
- 체계적인 데이터 처리 파이프라인
- 모듈화된 함수 구조
- 상세한 주석과 문서화
- 에러 처리 메커니즘 포함

**개선 제안:**
1. 데이터 검증 단계 추가
2. 학습 진행 상황 모니터링 기능
3. 체크포인트 저장 로직 구현
4. 하이퍼파라미터 튜닝 자동화 검토

#### 3.4.5 finetuning_model.ipynb 분석

**파일 개요:**
- LLaVA 모델의 파인튜닝을 위한 환경 설정 및 학습 구현
- 딥페이크 탐지를 위한 커스텀 데이터셋 학습 파이프라인

**주요 기능:**
1. **환경 설정**
   - LLaVA 레포지토리 클론 및 설정
   - 필수 라이브러리 설치 (ninja, flash-attn 등)
   - CUDA 환경 구성

2. **의존성 관리**
   - torch, torchvision 버전 관리
   - transformers, accelerate 설정
   - deepspeed 통합

3. **학습 준비**
   - 데이터셋 전처리 및 포맷팅
   - 모델 설정 및 하이퍼파라미터 조정
   - 분산 학습 환경 구성

**코드 품질:**
- 체계적인 환경 설정 구조
- 의존성 버전 관리
- 상세한 설치 과정 문서화
- 에러 처리 포함

**개선 제안:**
1. 환경 설정 자동화 스크립트 추가
2. 의존성 버전 충돌 해결 로직 개선
3. 설치 과정 진행 상황 표시 개선
4. 에러 발생 시 복구 방안 문서화

#### 3.4.6 fine.ipynb 분석

**파일 개요:**
- Together API를 활용한 간단한 파인튜닝 실험
- 모델 학습을 위한 기본 설정 및 데이터 업로드 구현

**주요 기능:**
1. **API 설정**
   - Together API 클라이언트 설치 및 초기화
   - API 키 환경 변수 설정
   - 기본 명령어 테스트

2. **데이터 처리**
   - JSONL 형식 데이터 업로드
   - 파일 관리 기능 테스트
   - 데이터셋 검증

3. **실험 환경**
   - 기본 파라미터 설정
   - 에러 처리 및 로깅
   - API 응답 처리

**코드 품질:**
- 기본적인 API 연동 구조
- 에러 메시지 처리
- 간단한 실험 구성
- 테스트 코드 포함

**개선 제안:**
1. API 키 보안 강화
2. 에러 처리 로직 개선
3. 실험 결과 저장 기능 추가
4. 설정 파일 분리 검토
